!function(Y,y){"use strict";var S="ht",Z=S+".layout.",w=Y[S]||module.parent.exports.ht,O=w.List,x=w.DataModel,E=w.Node,H=w.Edge,_=w.Group,k=Math,A=k.sqrt,n=k.random,K=k.max,s=k.min,L=function(O){return O*O};w.Default.getInternal().addMSMap({ms_force:function(r){r._interval=50,r._stepCount=10,r._motionLimit=.01,r._edgeRepulsion=.65,r._nodeRepulsion=.65,r._damper=1,r._maxMotion=0,r._motionRatio=0,r.init=function(S){var b=this;S instanceof x?b.dm=S:b.gv=S,b._nodeMap={},b._nodes=new O,b._edges=new O},r.start=function(){var j=this,F=j.gv;if(!j._timer){var Y=j.cdm=F?F.dm():j.dm;Y.mm(j.handleDataModelChange,j),Y.md(j.handleDataPropertyChange,j),F&&F.mp(j.handleGV,j),Y.each(function(B){if(j.isVisible(B)&&j.isLayoutable(B)&&B instanceof E)if(j instanceof T){var s=B.p3();B.p3([s[0]+n(),s[1]+n(),s[2]+n()])}else s=B.p(),B.p(s.x+n(),s.y+n())}),j._timer=setInterval(function(){j.relax()},j._interval),j._damper=1}},r.stop=function(){var y=this;y._timer&&(y.cdm.umm(y.handleDataModelChange,y),y.cdm.umd(y.handleDataPropertyChange,y),y.gv&&y.gv.ump(y.handleGV,y),clearInterval(y._timer),delete y._timer,delete y.cdm)},r.handleGV=function(v){var m=this;if("dataModel"===v.property){var C=v.oldValue,l=v.newValue;C&&(C.umm(m.handleDataModelChange,m),C.umd(m.handleDataPropertyChange,m)),this.cdm=l,l.mm(m.handleDataModelChange,m),l.md(m.handleDataPropertyChange,m)}},r.relax=function(){var L=this;if(!(L._damper<.1&&L._maxMotion<L._motionLimit)){this.cdm.each(function(p){L.isVisible(p)&&(p instanceof H?L.addEdge(p):p instanceof E&&L.addNode(p))});for(var e,U,_=0,J=L._edges,I=L._nodes,X=I.size();_<L._stepCount;_++){for(J.each(L.relaxEdge,L),e=0;X>e;e++)for(U=0;X>U;U++)L.relaxNode(I.get(e),I.get(U));L.moveNode()}L._isAdjusting=1,I.each(function(l){l.fix||(l.p?l.v.p3(l.p):l.v.p(l.x,l.y))}),delete L._isAdjusting,L._nodeMap={},I.clear(),J.clear(),L.onRelaxed()}},r.onRelaxed=function(){},r.isRunning=function(){return!!this._timer},r.isVisible=function(M){return M.s("layoutable")===!1?!1:this.gv?this.gv.isVisible(M):!0},r.isLayoutable=function(W){if(W.s("layoutable")===!1)return!1;if(W instanceof _)return!1;var N=this;return N.gv?N.gv.isMovable(W)&&!N.gv.isSelected(W):!(N.cdm||N.dm).sm().co(W)},r.getNodeRepulsion=function(){return this._nodeRepulsion},r.setNodeRepulsion=function(F){this._nodeRepulsion=F,this._damper=1},r.getEdgeRepulsion=function(){return this._edgeRepulsion},r.setEdgeRepulsion=function(v){this._edgeRepulsion=v,this._damper=1},r.getStepCount=function(){return this._stepCount},r.setStepCount=function($){this._stepCount=$,this._damper=1},r.getInterval=function(){return this._interval},r.setInterval=function(R){var t=this;t._interval!==R&&(t._interval=R,t._timer&&(clearInterval(t._timer),t._timer=setInterval(function(){t.relax()},R)))},r.handleDataPropertyChange=function(w){!this._isAdjusting&&this.isVisible(w.data)&&(this._damper=1)},r.handleDataModelChange=function(){this._damper=1},r.damp=function(){var m=this._maxMotion,S=this._damper;this._motionRatio<=.001&&((.2>m||m>1&&.9>S)&&S>.01?this._damper-=.01:.4>m&&S>.003?this._damper-=.003:S>1e-4&&(this._damper-=1e-4)),m<this._motionLimit&&(this._damper=0)}}}),w.layout.ForceLayout=function(r){this.init(r)},w.Default.def(Z+"ForceLayout",y,{ms_force:1,getLimitBounds:function(){return this._limitBounds},setLimitBounds:function(X){this._limitBounds=X,this._damper=1},getNodeSize:function(l){var Z=this.gv;return Z&&Z.getDataUIBounds?Z.getDataUIBounds(l):l.getRect()},addNode:function(z){var V=this,t=V._nodeMap[z._id];if(t)return t;var H=z.p();t={v:z,x:H.x,y:H.y,dx:0,dy:0,fix:!V.isLayoutable(z),s:V.getNodeSize(z)};var f=t.s,U=A(L(f.width)+L(f.height))*V._nodeRepulsion;return t.r=1>U?100:U,V._nodeMap[z._id]=t,V._nodes.add(t),t},addEdge:function(g){if(g._40I&&g._41I){var f=this,N=f.addNode(g._40I),C=f.addNode(g._41I),l={s:N,t:C};C=C.s,N=N.s;var i=C.width+N.width,d=C.height+N.height;l.length=A(i*i+d*d)*f._edgeRepulsion,l.length<=0&&(l.length=100),f._edges.add(l)}},relaxEdge:function(R){var y=R.t,G=R.s,B=y.x-G.x,X=y.y-G.y,P=A(B*B+X*X),s=100*R.length,Y=.25*B/s*P,k=.25*X/s*P;y.dx=y.dx-Y,y.dy=y.dy-k,G.dx=G.dx+Y,G.dy=G.dy+k},relaxNode:function(Y,I){if(Y!==I){var u=0,D=0,t=Y.x-I.x,Q=Y.y-I.y,K=t*t+Q*Q;0===K?(u=n(),D=n()):36e4>K&&(u=t/K,D=Q/K);var F=Y.r*I.r/400;u*=F,D*=F,Y.dx+=u,Y.dy+=D,I.dx-=u,I.dy-=D}},moveNode:function(){var $=this,e=$._limitBounds,X=$._maxMotion,b=0,E=$._damper;$._nodes.each(function(k){if(!k.fix){var S=k.dx*E,n=k.dy*E;if(k.dx=S/2,k.dy=n/2,b=K(A(S*S+n*n),b),k.x+=K(-40,s(40,S)),k.y+=K(-40,s(40,n)),e){k.x<e.x&&(k.x=e.x,$.adjust(1,0)),k.y<e.y&&(k.y=e.y,$.adjust(0,1));var N=k.s;k.x+N.width>e.x+e.width&&(k.x=e.x+e.width-N.width,$.adjust(-1,0)),k.y+N.height>e.y+e.height&&(k.y=e.y+e.height-N.height,$.adjust(0,-1))}}}),$._maxMotion=b,$._motionRatio=b>0?X/b-1:0,$.damp()},adjust:function(n,X){var d=this._limitBounds;this._nodes.each(function(i){n>0?(!d||i.x+i.s.width+n<d.x+d.width)&&(i.x+=n):(!d||i.x+n>d.x)&&(i.x+=n),X>0?(!d||i.y+i.s.height+X<d.y+d.height)&&(i.y+=X):(!d||i.y+X>d.y)&&(i.y+=X)})}});var T=w.layout.Force3dLayout=function(B){this.init(B)};w.Default.def(Z+"Force3dLayout",y,{ms_force:1,getNodeSize3d:function($){return $.s3()},addNode:function(y){var s=this,V=s._nodeMap[y._id];if(V)return V;V={v:y,p:y.p3(),d:[0,0,0],fix:!s.isLayoutable(y),s:s.getNodeSize3d(y)};var b=V.s,P=w.Default.getDistance(b)*s._nodeRepulsion;return V.r=1>P?100:P,s._nodeMap[y._id]=V,s._nodes.add(V),V},addEdge:function(h){if(h._40I&&h._41I){var R=this,m=R.addNode(h._40I),Q=R.addNode(h._41I),g={s:m,t:Q};Q=Q.s,m=m.s,g.length=A(L(Q[0]+m[0])+L(Q[1]+m[1])+L(Q[2]+m[2]))*R._edgeRepulsion,g.length<=0&&(g.length=100),R._edges.add(g)}},relaxEdge:function(g){var l=g.t.p,N=g.s.p,y=g.t.d,X=g.s.d,B=l[0]-N[0],v=l[1]-N[1],x=l[2]-N[2],q=A(B*B+v*v+x*x),a=100*g.length,C=.25*B/a*q,u=.25*v/a*q,G=.25*x/a*q;y[0]-=C,y[1]-=u,y[2]-=G,X[0]+=C,X[1]+=u,X[2]+=G},relaxNode:function(D,c){if(D!==c){var H=D.p,T=c.p,X=0,q=0,p=0,v=H[0]-T[0],Z=H[1]-T[1],w=H[2]-T[2],j=v*v+Z*Z+w*w;0===j?(X=n(),q=n(),p=n()):216e6>j&&(X=v/j,q=Z/j,p=w/j);var O=D.r*c.r/400,e=D.d,t=c.d;X*=O,q*=O,p*=O,e[0]+=X,e[1]+=q,e[2]+=p,t[0]-=X,t[1]-=q,t[2]-=p}},moveNode:function(){var O=this,n=O._maxMotion,y=0,a=O._damper;O._nodes.each(function(W){if(!W.fix){var O=W.p,$=W.d,n=$[0]*a,J=$[1]*a,P=$[2]*a;$[0]=n/2,$[1]=J/2,$[2]=P/2,y=K(A(n*n+J*J+P*P),y),O[0]+=K(-40,s(40,n)),O[1]+=K(-40,s(40,J)),O[2]+=K(-40,s(40,P))}}),O._maxMotion=y,O._motionRatio=y>0?n/y-1:0,O.damp()}})}(this,Object);